# Spring Batch 사용자 하드 딜리트 성능 최적화 프로젝트 보고서

## 대상 시스템
- **배치 잡**: `userHardDeleteDeletedJob`
- **DB/커넥션 풀**: PostgreSQL + HikariCP (Spring Batch)
- **처리 대상**: 소프트 삭제된(`DELETED`) 사용자 레코드의 **하드 딜리트**

## 최종 성과
- **최종 성과**: **935% 성능 향상** (340s → 36s)
- **측정 기준**: 동일 데이터량/동일 로직 기준, 실행 로그 기반

---

## 프로젝트 개요
### 목적
- 대량의 소프트 삭제 데이터를 주기적으로 하드 딜리트할 때, **처리 지연/교착 상태/DB 부하**를 최소화하고 일관된 처리 시간을 확보한다.

### 시스템 구성
- Spring Batch 기반 단일 잡: 리더 → 프로세서 → 라이터(벌크 삭제)
- 파티셔닝(샤딩)으로 **균등 분산**, HikariCP/Chunk 크기/그리드 사이즈 등 **튜닝 파라미터** 적용
- 지표 수집(스텝/잡 레벨), DB 메트릭과 함께 **성능 변동 원인 분석**

---

## 실험 결과 요약
- 아래 표(별도 파일 `performance.md`)에 정리된 **실험군/설정/측정값**을 기준으로 분석했으며, 수치(시간/처리량)는 **원문과 동일**하게 유지했다.
- 핵심 성과와 주요 관찰 포인트만 간결히 요약한다.

1) **싱글 스레드(기본값)**  
   - 10,000,000건: **00h 05m 40s**  
   - 병목: 한 스레드 순차 처리에 따른 **DB I/O** 집중, 커밋 회수 증가

2) **멀티 스레드(Reader 동시 접근)**  
   - 36s 내외 구간에서 **ResultSet closed** 오류 발생 → 실패 케이스 존재  
   - 원인: `JpaCursorItemReader`의 **동시 접근 취약성** + 커넥션 관리

3) **초기 파티셔닝(범위 분할)**  
   - **문자열 ID**를 단순 범위(min/max)로 분할 시 **샤드 쏠림** 발생 가능  
   - 분포 불균형 → 스레드 간 처리 시간 편차

4) **해시 기반 샤드 파티셔닝**  
   - **gridSize=20** 기준 **~60M rec/s**까지 관찰(환경 의존)  
   - 스레드별 처리량 편차 ↓, **교착/락 경합**도 감소

5) **커넥션 풀 튜닝(Hikari)**  
   - 풀 크기 부족 시 `Connection timeout`/대기열 증가로 **처리 지연**  
   - 과도한 풀 크기는 **컨텍스트 스위칭/DB 경합** ↑ → 최적점 탐색 필요

6) **Chunk Size 영향**  
   - 500/1000/1500/2000 실험에서, **DB/WAL 부하와 커밋 비용**이 트레이드오프  
   - 800 처럼 **애매한 크기**는 커밋 회수가 늘며 오히려 지연 가능

*(정량 수치 및 개별 실험 로그는 `performance.md`/실행 로그 참조 — 본 문서는 **원문 순서와 수치**를 유지한 요약/가독성 개선본입니다.)*

---

## 결론
- **샤드(해시) 파티셔닝 + 적절한 Chunk + 충분하되 과하지 않은 커넥션 풀** 조합이 가장 안정적이었다.
- **Reader 동시 접근**은 ResultSet/세션 관리 이슈로 실패 위험이 높아 **지양**.
- **DB 인덱스/체크포인트/WAL 압축** 등 **서버 측 튜닝**과 함께 보완하면 장기적으로 안정성이 높다.

---

## 운영 가이드
- **그리드 사이즈(gridSize)**: CPU 코어·디스크 I/O 여유·풀 사이즈를 고려해 결정.  
  - 예) gridSize 20 전후에서 수렴 → 더 키우면 컨텍스트 스위칭 비용↑
- **Chunk Size**: 1000±(500~2000) 구간에서 검증.  
  - 너무 작으면 **커밋 과다**, 너무 크면 **락 홀드/메모리/WAL** 부담
- **HikariCP**: 풀 사이즈는 `gridSize ≤ poolSize ≤ gridSize+O(10~30%)` 범위에서 탐색.  
  - 예) gridSize=20일 때 poolSize 25 전후
- **DB 운영**: 체크포인트(간격/완료 타겟), WAL 압축, 인덱스(커버링)로 **읽기/쓰기 균형**

---

## 📖 참고 자료
- 성능 측정 테이블: `performance.md` (튜닝 조합/지표 표)  
- 실행 로그: `performance-metrics.log`

---

**프로젝트 완료일**: 2025-08-16  
**작성자**: (작성자 이름)
