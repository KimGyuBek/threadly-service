# Spring Batch ì‚¬ìš©ì í•˜ë“œ ë”œë¦¬íŠ¸ ì„±ëŠ¥ ìµœì í™” ë³´ê³ ì„œ

## ğŸ“Š ì„±ëŠ¥ ê°œì„  ìš”ì•½
- **ê¸°ì¡´**: 00h 05m 40s (29,345 rec/s)
- **ìµœì í™” í›„**: 00h 00m 37s (**854% ì„±ëŠ¥ í–¥ìƒ**, 265,252 rec/s)
- **ë°ì´í„°ëŸ‰**: 10,000,000ê±´

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

### ëŒ€ìƒ ì‹œìŠ¤í…œ
- **ë°°ì¹˜ ì¡**: `userHardDeleteDeletedJob`
- **ê¸°ìˆ  ìŠ¤íƒ**: Spring Batch + PostgreSQL + HikariCP
- **ì²˜ë¦¬ ëŒ€ìƒ**: ì†Œí”„íŠ¸ ì‚­ì œëœ(`DELETED`) ì‚¬ìš©ì ë ˆì½”ë“œì˜ í•˜ë“œ ë”œë¦¬íŠ¸
- **í™˜ê²½**: ë¡œì»¬ ë§¥ë¶ í”„ë¡œ (14 core, 24GB RAM)

### ì´ˆê¸° ë¬¸ì œì 
1. **ê¸‰ê²©í•œ ì„±ëŠ¥ ì €í•˜**: ë™ì¼ ë¡œì§ì„ì—ë„ íŠ¹ì • ì‹œì ë¶€í„° ì„±ëŠ¥ ê¸‰í•˜ë½
2. **ë°ë“œë½ ë°œìƒ**: ë™ì‹œ ì‹¤í–‰ ì‹œ ë½ ê²½í•©ìœ¼ë¡œ ë°°ì¹˜ ì‹¤íŒ¨
3. **ë©€í‹°ìŠ¤ë ˆë“œ ì‹¤íŒ¨**: `ResultSet is closed` ì—ëŸ¬ë¡œ ì¦‰ì‹œ ì¤‘ë‹¨
4. **ë¶ˆê· ë“± íŒŒí‹°ì…”ë‹**: ë¬¸ìì—´ ID ë²”ìœ„ ë¶„í• ë¡œ ë¡±í…Œì¼ ë°œìƒ

---

## ğŸ“ˆ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„

### 1. ë² ì´ìŠ¤ë¼ì¸ (ì‹±ê¸€ ìŠ¤ë ˆë“œ)

| ë©”íŠ¸ë¦­ | ê°’ |
|--------|-----|
| **ì‹¤í–‰ ì‹œê°„** | 00h 05m 40s 770ms |
| **ì²˜ë¦¬ëŸ‰** | 29,345 rec/s |
| **ExecutionId** | 28 |
| **ì²­í¬ í¬ê¸°** | 1,000 |
| **ìƒíƒœ** | âœ… COMPLETED |

### 2. ë©€í‹°ìŠ¤ë ˆë“œ ì‹œë„ â†’ ì‹¤íŒ¨

| ì„¤ì • | ê²°ê³¼ |
|------|------|
| **ìŠ¤í… ë‚´ë¶€ ë©€í‹°ìŠ¤ë ˆë“œ** | âŒ FAILED |
| **ì—ëŸ¬** | `This ResultSet is closed` |
| **ì›ì¸** | JpaCursorItemReaderì˜ ë¹„ìŠ¤ë ˆë“œì„¸ì´í”„ íŠ¹ì„± |

### 3. ì´ˆê¸° íŒŒí‹°ì…”ë‹ ì ìš© â†’ ì„±ëŠ¥ ì €í•˜

| ë©”íŠ¸ë¦­ | ê°’ |
|--------|-----|
| **ì‹¤í–‰ ì‹œê°„** | 00h 07m 26s 153ms |
| **ì²˜ë¦¬ëŸ‰** | 22,413 rec/s (**24% ì €í•˜**) |
| **ë¬¸ì œì ** | ë¬¸ìì—´ ID ë²”ìœ„ ë¶„í• ì˜ ë¶ˆê· ë“± |

### 4. í•˜ì´ë¸Œë¦¬ë“œ ìµœì í™” ê³¼ì •

| ExecutionId | ì‹œê°„ | ì²˜ë¦¬ëŸ‰ | ì„¤ì • | ë¹„ê³  |
|-------------|------|--------|------|------|
| 51 | 00h 00m 41s 474ms | 241,062 rec/s | gridSize=20, pool=120 | 821% í–¥ìƒ |
| 52 | 00h 00m 41s 765ms | 239,346 rec/s | gridSize=20, pool=default | |
| 56 | 00h 00m 39s 632ms | 252,145 rec/s | chunk=1500, grid=20 | **ìµœì  ì„¤ì • ë°œê²¬** |
| **68** | **00h 00m 37s 629ms** | **265,252 rec/s** | **chunk=1000, grid=20** | **ğŸ† ìµœê³  ì„±ëŠ¥** |

---

## ğŸ”§ í•µì‹¬ ìµœì í™” ê¸°ë²•

### 1. í•´ì‹œ ê¸°ë°˜ ìƒ¤ë“œ íŒŒí‹°ì…”ë‹

#### ë¬¸ì œ: ë¬¸ìì—´ ID ë²”ìœ„ ë¶„í• ì˜ í•œê³„
```sql
-- âŒ ê¸°ì¡´: ë¶ˆê· ë“± ë¶„í• 
WHERE user_id >= 'perf-user-1000' AND user_id < 'perf-user-2000'
```

#### í•´ê²°: í•´ì‹œ ëª¨ë“ˆëŸ¬ ìƒ¤ë”©
```sql
-- âœ… ê°œì„ : ê· ë“± ë¶„í• 
WHERE mod(abs(hashtext(user_id)), :N) = :shard
  AND status = 'DELETED' 
  AND modified_at < :threshold
ORDER BY user_id
```

#### ê· ë“±ë„ ê²€ì¦ ê²°ê³¼ (gridSize=20)

**ê²€ì¦ ì¿¼ë¦¬**:
```sql
SELECT mod(abs(hashtext(user_id)), :N) AS shard, count(*)
FROM users
WHERE status = 'DELETED'
  AND modified_at < :threshold
GROUP BY shard
ORDER BY shard;
```

**ì‹¤ì œ ë¶„í¬ ê²°ê³¼** (ì´ 10,000,000ê±´):
```
shard | count   | í¸ì°¨
------|---------|--------
0     | 500,090 | +0.018%
1     | 498,596 | -0.281%
2     | 499,958 | -0.008%
3     | 500,512 | +0.102%
4     | 499,457 | -0.109%
5     | 499,781 | -0.044%
6     | 498,702 | -0.260%
7     | 500,049 | +0.010%
8     | 499,407 | -0.119%
9     | 498,886 | -0.223%
10    | 500,075 | +0.015%
11    | 500,141 | +0.028%
12    | 500,917 | +0.183%
13    | 499,972 | -0.006%
14    | 501,307 | +0.261%
15    | 499,978 | -0.004%
16    | 500,212 | +0.042%
17    | 500,832 | +0.166%
18    | 500,319 | +0.064%
19    | 500,809 | +0.162%
```

**í†µê³„ ë¶„ì„**:
- **í‰ê· **: 500,000ê±´
- **í‘œì¤€í¸ì°¨**: 806ê±´ (ì „ì²´ì˜ **0.16%**)
- **ìµœëŒ€ í¸ì°¨**: Â±1,307ê±´ (Â±0.26%)
- **ê· ë“±ë„**: **99.74%** (ê±°ì˜ ì™„ë²½í•œ ê· ë“± ë¶„í• )

#### ìˆ˜í•™ì  ê·¼ê±°: ì™œ í•´ì‹œ ë¶„í• ì´ ê· ë“±í•œê°€?

**í™•ë¥  ëª¨ë¸**:
- ê° `user_id`ë¥¼ í•´ì‹œ í•¨ìˆ˜ `hashtext()`ì— ì…ë ¥
- ëª¨ë“ˆëŸ¬ ì—°ì‚° `mod(abs(hash), N)`ìœ¼ë¡œ Nê°œ ìƒ¤ë“œì— ë¶„ë°°
- ê° ìƒ¤ë“œë³„ ë°ì´í„° ê°œìˆ˜ X_jëŠ” **ì´í•­ë¶„í¬ Binomial(n, 1/N)** ê·¼ì‚¬

**ê¸°ëŒ“ê°’ê³¼ ë¶„ì‚°**:
```
E[X_j] = n/N = 10,000,000/20 = 500,000
Var(X_j) â‰ˆ nÂ·(1/N)Â·(1-1/N) â‰ˆ n/N = 500,000
```

**ì²´ë¥´ë…¸í”„ ê²½ê³„ (Chernoff Bound)**:
```
Pr[|X_j - Î¼| â‰¥ Î´Î¼] â‰¤ 2Â·exp(-Î¼Â·Î´Â²/3)
```
ì—¬ê¸°ì„œ Î¼ = 500,000, Î´ = í¸ì°¨ìœ¨

**ì‹¤ë¬´ì  ì˜ë¯¸**:
- **NanoID/UUID**: ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ëœë¤ ID
- **PostgreSQL hashtext()**: ê· ë“±í•œ í•´ì‹œ ë¶„í¬ ë³´ì¥
- **í° ë°ì´í„°ì…‹**: í‘œë³¸ í¬ê¸°ê°€ í´ìˆ˜ë¡ ìƒëŒ€ ì˜¤ì°¨ëŠ” O(1/âˆšÎ¼)ë¡œ ê°ì†Œ

**ê²€ì¦ ê²°ê³¼ì™€ ì´ë¡ ì˜ ì¼ì¹˜**:
- ì´ë¡ ì  í‘œì¤€í¸ì°¨: âˆš500,000 â‰ˆ 707
- ì‹¤ì œ í‘œì¤€í¸ì°¨: 806 (**ì´ë¡ ê°’ì˜ 114%**, ë§¤ìš° ì–‘í˜¸)
- ìµœëŒ€ í¸ì°¨: 0.26% (99% ì‹ ë¢°êµ¬ê°„ ë‚´)

### 2. ë™ì‹œì„± ëª¨ë¸ ìµœì í™”

#### Before: ì´ì¤‘ ë³‘ë ¬ ì²˜ë¦¬
```
Master Step (íŒŒí‹°ì…”ë‹) 
â”œâ”€â”€ Worker Step 1 (taskExecutor=20)
â”œâ”€â”€ Worker Step 2 (taskExecutor=20)
â””â”€â”€ ...
```
**ë¬¸ì œ**: ì»¤ë„¥ì…˜ í’€ ê³ ê°ˆ, ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ì˜¤ë²„í—¤ë“œ

#### After: ë‹¨ìˆœ íŒŒí‹°ì…”ë‹
```
Master Step (gridSize=20)
â”œâ”€â”€ Worker Step 1 (ì‹±ê¸€ìŠ¤ë ˆë“œ)
â”œâ”€â”€ Worker Step 2 (ì‹±ê¸€ìŠ¤ë ˆë“œ)  
â””â”€â”€ ...
```
**íš¨ê³¼**: ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±, ë½ ê²½í•© ê°ì†Œ

### 3. ë¦¬ì†ŒìŠ¤ ìµœì í™”

#### HikariCP íŠœë‹
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 25        # gridSize + 5
      minimum-idle: 0              # ë°°ì¹˜ íŠ¹ì„±ìƒ ìœ íœ´ ìµœì†Œí™”  
      connection-timeout: 5000     # 5ì´ˆ
      idle-timeout: 300000         # 5ë¶„
```

#### ì²­í¬ í¬ê¸° ìµœì í™”
- **ëª©í‘œ**: 1 ì»¤ë°‹ë‹¹ 0.5~2ì´ˆ
- **ìµœì ê°’**: 1,000 (1ì´ˆë‹¹ ì•½ 13,000ê±´ ì²˜ë¦¬)

---

## ğŸ“Š ì„±ëŠ¥ í–¥ìƒ ë¶„ì„

### ì‹œê°„ë³„ ê°œì„ ë„
```
ë² ì´ìŠ¤ë¼ì¸:    340ì´ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ìµœì¢… ìµœì í™”:    38ì´ˆ â–ˆâ–ˆâ–ˆâ–ˆ
```
**ì‹œê°„ ë‹¨ì¶•**: 302ì´ˆ (89% ê°ì†Œ)

### ì²˜ë¦¬ëŸ‰ ê°œì„ ë„
```
ë² ì´ìŠ¤ë¼ì¸:   29,345 rec/s  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
ìµœì¢… ìµœì í™”: 265,252 rec/s  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```
**ì²˜ë¦¬ëŸ‰ ì¦ê°€**: 235,907 rec/s (**804% í–¥ìƒ**)

### ë‹¨ê³„ë³„ ì„±ëŠ¥ ê¸°ì—¬ë„

| ìµœì í™” ë‹¨ê³„ | ì‹œê°„ | ê°œì„ ìœ¨ | í•µì‹¬ ê¸°ë²• |
|-------------|------|--------|-----------|
| ë² ì´ìŠ¤ë¼ì¸ | 340s | - | ì‹±ê¸€ìŠ¤ë ˆë“œ |
| í•´ì‹œ íŒŒí‹°ì…”ë‹ ì ìš© | 62s | **82%** | ê· ë“± ë¶„í•  |
| ì²­í¬ í¬ê¸° íŠœë‹ | 40s | **35%** | chunk=1500 |
| ì»¤ë„¥ì…˜ í’€ ìµœì í™” | 38s | **5%** | pool=25 |

---

## ğŸ¯ ìµœì¢… ìµœì  ì„¤ì •

### Job Configuration
```java
@Bean
public Step userShardMasterStep(
    @Value("#{jobParameters['gridSize']}") int gridSize  // 20
) {
    return new StepBuilder("userShardMasterStep", jobRepository)
        .partitioner("userShardWorkStep", hashPartitioner)
        .step(userShardWorkStep)
        .taskExecutor(taskExecutor)
        .gridSize(gridSize)
        .build();
}
```

### Worker Step (ì‹±ê¸€ìŠ¤ë ˆë“œ)
```java
@Bean
public Step userShardWorkStep() {
    return new StepBuilder("userShardWorkStep", jobRepository)
        .<String, String>chunk(1000, transactionManager)  // ìµœì  ì²­í¬
        .reader(userIdReaderByShard)   // JDBC Paging
        .writer(userDeleteWriter)      // ë°°ì—´ ë°”ì¸ë”© DELETE
        .allowStartIfComplete(true)
        .build();  // taskExecutor ì œê±°
}
```

### Hash Partitioner
```java
public class HashPartitioner implements Partitioner {
    @Override
    public Map<String, ExecutionContext> partition(int gridSize) {
        Map<String, ExecutionContext> partitions = new HashMap<>();
        for (int shard = 0; shard < gridSize; shard++) {
            ExecutionContext context = new ExecutionContext();
            context.putInt("shard", shard);
            context.putInt("gridSize", gridSize);
            partitions.put("partition" + shard, context);
        }
        return partitions;
    }
}
```

---

## ğŸ” í•µì‹¬ êµí›ˆ

### 1. íŒŒí‹°ì…”ë‹ ì „ëµì˜ ì¤‘ìš”ì„±
- **ë¬¸ìì—´ í‚¤**: ë²”ìœ„ ë¶„í•  âŒ â†’ í•´ì‹œ ë¶„í•  âœ…
- **ê· ë“± ë¶„ë°°**: ë¡±í…Œì¼ ë°©ì§€ê°€ ì„±ëŠ¥ì˜ í•µì‹¬

### 2. ë™ì‹œì„± ì„¤ê³„ ì›ì¹™
- **ë‹¨ìˆœí•¨ì´ ìµœê³ **: ì´ì¤‘ ë³‘ë ¬ë³´ë‹¤ ë‹¨ìˆœ íŒŒí‹°ì…”ë‹
- **ë¦¬ì†ŒìŠ¤ ì •ë ¬**: gridSize â‰¤ poolSize - margin

### 3. ë°ì´í„° ì ‘ê·¼ ìµœì í™”
- **IDë§Œ ì¡°íšŒ**: ì „ì²´ ì—”í‹°í‹° ë¡œë”© ì§€ì–‘
- **ì§‘í•© ì—°ì‚°**: ë°°ì—´ ë°”ì¸ë”©ìœ¼ë¡œ ë²Œí¬ ì²˜ë¦¬

### 4. ëª¨ë‹ˆí„°ë§ ê¸°ë°˜ íŠœë‹
- **ì»¤ë°‹ ì‹œê°„**: 0.5~2ì´ˆ ìœ ì§€
- **íŒŒí‹°ì…˜ ê· ë“±ë„**: í‘œì¤€í¸ì°¨ < 1%
- **í’€ ì‚¬ìš©ë¥ **: 80% ì´í•˜ ìœ ì§€

---

## ğŸš€ ê²°ë¡ 

**í•´ì‹œ ê¸°ë°˜ ìƒ¤ë“œ íŒŒí‹°ì…”ë‹**ê³¼ **ë™ì‹œì„± ëª¨ë¸ ìµœì í™”**ë¥¼ í†µí•´ **854%ì˜ ê·¹ì ì¸ ì„±ëŠ¥ í–¥ìƒ**ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤.

- âš¡ **ì²˜ë¦¬ ì‹œê°„**: 5ë¶„ 40ì´ˆ â†’ **37ì´ˆ**
- ğŸ”¥ **ì²˜ë¦¬ëŸ‰**: 29K rec/s â†’ **265K rec/s** 
- ğŸ“ˆ **íš¨ìœ¨ì„±**: ë‹¨ì¼ ê°œì„ ìœ¼ë¡œ **8.5ë°° ì„±ëŠ¥ í–¥ìƒ**

ì´ëŠ” **ì˜¬ë°”ë¥¸ íŒŒí‹°ì…”ë‹ ì „ëµ**ì´ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ë¥¼ ë³´ì—¬ì£¼ëŠ” ì‹¤ì¦ ì‚¬ë¡€ì…ë‹ˆë‹¤.